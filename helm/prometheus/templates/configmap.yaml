apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "prometheus.fullname" . }}-config
  labels:
    {{- include "prometheus.labels" . | nindent 4 }}
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        monitor: 'taxi-monitor'

    {{- if .Values.prometheus.remoteWrite.enabled }}
    # Remote write to VictoriaMetrics
    remote_write:
      - url: {{ .Values.prometheus.remoteWrite.url }}
    {{- end }}

    scrape_configs:
      # Prometheus itself
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:{{ .Values.service.ports.http }}']

      # Taxi Data Processor (Database Application)
      - job_name: 'taxi-data-processor'
        metrics_path: '/metrics'
        static_configs:
          - targets: ['taxi-data-processor:8080']
            labels:
              application: 'taxi-data-processor'
              module: 'database'

      # Taxi Data Indexer (Indexing Application)
      - job_name: 'taxi-data-indexer'
        metrics_path: '/metrics'
        static_configs:
          - targets: ['taxi-data-indexer:8081']
            labels:
              application: 'taxi-data-indexer'
              module: 'indexing'
  {{- if .Values.tls.enabled }}
  web.yml: |
    # Prometheus Web Configuration for TLS
    tls_server_config:
      cert_file: {{ .Values.tls.certDir }}/{{ .Values.tls.certFile }}
      key_file: {{ .Values.tls.certDir }}/{{ .Values.tls.keyFile }}

    http_server_config:
      http2: true
  {{- end }}

